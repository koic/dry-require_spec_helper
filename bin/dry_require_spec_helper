#!/usr/bin/env ruby

unless File.exist?('.rspec')
  puts 'dry_require_spec_helper: .rspec: No such file or directory'

  exit 1
end

helper_name = if File.exist?('Gemfile.lock') &&
  File.read('Gemfile.lock').split("\n").detect {|gem| /rspec-rails \((\d)\.(\d)\.(\d)\)$/ === gem } &&
  $1.to_i >= 3
  'rails_helper'
else
  'spec_helper'
end

File.open('.rspec', 'a') {|file| file.write("--require #{helper_name}\n") }

Dir['./spec/**/*_spec.rb'].each do |path|
  source = File.read(path)

  next unless /require +('(spec|rails)_helper'|"(spec|rails)_helper")\n*/ === source

  source.gsub!($&, '')

  File.open(path, 'w+') {|f| f.write(source) }
end
